apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
        - name: api-gateway
          image: api-gateway:latest
          imagePullPolicy: Always
          resources:
            limits:
              memory: "1024Mi"
              cpu: "500m"
            requests:
              memory: "256Mi"
              cpu: "100m"
          ports:
            - containerPort: 9000
          env:
            - name: SERVER_PORT
              value: "9000"
            - name: SERVER_FORWARD_HEADERS_STRATEGY
              value: "framework"

            - name: SPRING_CLOUD_CONSUL_ENABLED
              value: "false"
            - name: SPRING_CLOUD_CONSUL_DISCOVERY_ENABLED
              value: "false"
            - name: SPRING_CONFIG_IMPORT
              value: ""
            - name: GOOGLE_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: google-oauth-secret
                  key: GOOGLE_CLIENT_ID

            - name: GOOGLE_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: google-oauth-secret
                  key: GOOGLE_CLIENT_SECRET
            - name: SPRING_APPLICATION_JSON
              value: >
                {
                  "spring": {
                    "cloud": {
                      "gateway": {
                        "routes": [
                          {
                            "id": "movie-service",
                            "uri": "http://movie-service:80",
                            "predicates": ["Path=/api/movie/**, /api/director/**, /api/genre/**"]
                          },
                          {
                            "id": "movie-session-service",
                            "uri": "http://movie-session-service:3500",
                            "predicates": ["Path=/api/movie-session/**"]
                          },
                          {
                            "id": "frontend",
                            "uri": "http://frontend:80",
                            "predicates": ["Path=/**"]
                          }
                        ]
                      }
                    }
                  }
                }

            - name: MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED
              value: "true"

          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 9000
            initialDelaySeconds: 45
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 9000
            initialDelaySeconds: 90
            periodSeconds: 30